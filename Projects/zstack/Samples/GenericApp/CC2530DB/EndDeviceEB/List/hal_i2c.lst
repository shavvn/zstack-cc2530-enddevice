###############################################################################
#                                                                             #
# IAR C/C++ Compiler V7.60.1.40026 for 8051             04/May/2014  15:12:53 #
# Copyright (C) 2004-2010 IAR Systems AB.                                     #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#    Source file        =  C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Components\hal\target\CC2530EB\hal_i2c.c     #
#    Command line       =  -f C:\Users\John\Dropbox\grad_proj\zstack-cc2530-e #
#                          nddevice\Projects\zstack\Samples\GenericApp\CC2530 #
#                          DB\..\..\..\Tools\CC2530DB\f8wEndev.cfg            #
#                          (-DCPU32MHZ -DROOT=__near_func                     #
#                          -DMAC_CFG_TX_DATA_MAX=3 -DMAC_CFG_TX_MAX=6         #
#                          -DMAC_CFG_RX_MAX=3) -f C:\Users\John\Dropbox\grad_ #
#                          proj\zstack-cc2530-enddevice\Projects\zstack\Sampl #
#                          es\GenericApp\CC2530DB\..\..\..\Tools\CC2530DB\f8w #
#                          Config.cfg (-DZIGBEEPRO -DSECURE=0                 #
#                          -DZG_SECURE_DYNAMIC=0 -DREFLECTOR                  #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0x1111                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DLINK_STATUS_JITTER_MASK=0x007F                   #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116                           #
#                          -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const     #
#                          __code" -DGENERIC=__generic                        #
#                          -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=8000        #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100)   #
#                          -DREJOIN_POLL_RATE=440 C:\Users\John\Dropbox\grad_ #
#                          proj\zstack-cc2530-enddevice\Components\hal\target #
#                          \CC2530EB\hal_i2c.c -D HAL_ADC=FALSE -D            #
#                          HAL_KEY=FALSE -D HAL_LED=FALSE -D HAL_LCD=FALSE    #
#                          -D NWK_AUTO_POLL -D ZTOOL_P1 -D MT_TASK -D         #
#                          MT_SYS_FUNC -D MT_ZDO_FUNC -D POWER_SAVING -D      #
#                          NV_STORE -lC C:\Users\John\Dropbox\grad_proj\zstac #
#                          k-cc2530-enddevice\Projects\zstack\Samples\Generic #
#                          App\CC2530DB\EndDeviceEB\List\ -lA                 #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          EndDeviceEB\List\ --diag_suppress Pe001,Pa010 -o   #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          EndDeviceEB\Obj\ -e --require_prototypes           #
#                          --no_code_motion --debug --core=plain --dptr=16,1  #
#                          --data_model=large --code_model=banked             #
#                          --calling_convention=xdata_reentrant               #
#                          --place_constants=data_rom --nr_virtual_regs 16    #
#                          -I C:\Users\John\Dropbox\grad_proj\zstack-cc2530-e #
#                          nddevice\Projects\zstack\Samples\GenericApp\CC2530 #
#                          DB\ -I C:\Users\John\Dropbox\grad_proj\zstack-cc25 #
#                          30-enddevice\Projects\zstack\Samples\GenericApp\CC #
#                          2530DB\..\Source\ -I C:\Users\John\Dropbox\grad_pr #
#                          oj\zstack-cc2530-enddevice\Projects\zstack\Samples #
#                          \GenericApp\CC2530DB\..\..\..\ZMain\TI2530DB\ -I   #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          ..\..\..\..\..\Components\hal\include\ -I          #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          ..\..\..\..\..\Components\hal\target\CC2530EB\ -I  #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          ..\..\..\..\..\Components\mac\include\ -I          #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          ..\..\..\..\..\Components\mac\high_level\ -I       #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          ..\..\..\..\..\Components\mac\low_level\srf04\ -I  #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          ..\..\..\..\..\Components\mac\low_level\srf04\sing #
#                          le_chip\ -I C:\Users\John\Dropbox\grad_proj\zstack #
#                          -cc2530-enddevice\Projects\zstack\Samples\GenericA #
#                          pp\CC2530DB\..\..\..\..\..\Components\mt\ -I       #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          ..\..\..\..\..\Components\osal\include\ -I         #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          ..\..\..\..\..\Components\osal\mcu\ccsoc\ -I       #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          ..\..\..\..\..\Components\services\saddr\ -I       #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          ..\..\..\..\..\Components\services\sdata\ -I       #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          ..\..\..\..\..\Components\stack\af\ -I             #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          ..\..\..\..\..\Components\stack\nwk\ -I            #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          ..\..\..\..\..\Components\stack\sapi\ -I           #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          ..\..\..\..\..\Components\stack\sec\ -I            #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          ..\..\..\..\..\Components\stack\sys\ -I            #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          ..\..\..\..\..\Components\stack\zdo\ -I            #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          ..\..\..\..\..\Components\zmac\ -I                 #
#                          C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          ..\..\..\..\..\Components\zmac\f8w\ -I             #
#                          "C:\Program Files (x86)\IAR Systems\Embedded       #
#                          Workbench 5.4\8051\INC\" -I "C:\Program Files      #
#                          (x86)\IAR Systems\Embedded Workbench               #
#                          5.4\8051\INC\CLIB\" -Ohz                           #
#    List file          =  C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          EndDeviceEB\List\hal_i2c.lst                       #
#    Object file        =  C:\Users\John\Dropbox\grad_proj\zstack-cc2530-endd #
#                          evice\Projects\zstack\Samples\GenericApp\CC2530DB\ #
#                          EndDeviceEB\Obj\hal_i2c.r51                        #
#                                                                             #
#                                                                             #
###############################################################################

C:\Users\John\Dropbox\grad_proj\zstack-cc2530-enddevice\Components\hal\target\CC2530EB\hal_i2c.c
      1          /**************************************************************************************************
      2            Filename:       hal_i2c.c
      3            Revised:        $Date: 2010-06-28 17:37:07 -0700 (Mon, 28 Jun 2010) $
      4            Revision:       $Revision: 22837 $
      5          
      6            Description:    I2C driver implementation.
      7          
      8          
      9            Copyright 2006 - 2010 Texas Instruments Incorporated. All rights reserved.
     10          
     11            IMPORTANT: Your use of this Software is limited to those specific rights
     12            granted under the terms of a software license agreement between the user
     13            who downloaded the software, his/her employer (which must be your employer)
     14            and Texas Instruments Incorporated (the "License").  You may not use this
     15            Software unless you agree to abide by the terms of the License. The License
     16            limits your use, and you acknowledge, that the Software may not be modified,
     17            copied or distributed unless embedded on a Texas Instruments microcontroller
     18            or used solely and exclusively in conjunction with a Texas Instruments radio
     19            frequency transceiver, which is integrated into your product.  Other than for
     20            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     21            works of, modify, distribute, perform, display or sell this Software and/or
     22            its documentation for any purpose.
     23          
     24            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     25            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED, 
     26            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE, 
     27            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     28            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     29            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     30            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     31            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     32            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     33            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     34            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     35          
     36            Should you have any questions regarding your right to use this Software,
     37            contact Texas Instruments Incorporated at www.TI.com. 
     38          **************************************************************************************************/
     39          
     40          /**************************************************************************************************
     41              This file contains the I2C interface to off-chip serial EEPROM. While
     42              much of the driver is generic, certain portions are specific to the
     43              Atmel part AT24C1024. For example, the 17th address bit occurs in the
     44              device address byte where one of the address pins should be. Different
     45              1 Mb parts use a different bit location. This could be abstracted at
     46              a later time if this is the only differentce among these parts.
     47          **************************************************************************************************/
     48          
     49          #include "ioCC2530.h"

   \                                 In  segment SFR_AN, at 0x90
   \   union <unnamed> volatile __sfr _A_P1
   \                     _A_P1:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xf4
   \   unsigned char volatile __sfr P1SEL
   \                     P1SEL:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xf5
   \   unsigned char volatile __sfr P2SEL
   \                     P2SEL:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xf7
   \   unsigned char volatile __sfr P2INP
   \                     P2INP:
   \   000000                DS 1

   \                                 In  segment SFR_AN, at 0xfe
   \   unsigned char volatile __sfr P1DIR
   \                     P1DIR:
   \   000000                DS 1
     50          #include "zcomdef.h"
     51          #include "hal_i2c.h"
     52          
     53          #define STATIC static
     54          
     55          #if !defined HAL_I2C_RETRY_CNT
     56          #define HAL_I2C_RETRY_CNT  3
     57          #endif
     58          
     59          // the default cofiguration below uses P1.6 for SDA and P0.0 for SCL.
     60          // change these as needed.
     61          #ifndef OCM_CLK_PORT
     62            #define OCM_CLK_PORT  1
     63          #endif
     64          
     65          #ifndef OCM_DATA_PORT
     66            #define OCM_DATA_PORT   1
     67          #endif
     68          
     69          #ifndef OCM_CLK_PIN
     70            #define OCM_CLK_PIN   6
     71          #endif
     72          
     73          #ifndef OCM_DATA_PIN
     74            #define OCM_DATA_PIN    7
     75          #endif
     76          
     77          // General I/O definitions
     78          #define IO_GIO  0  // General purpose I/O
     79          #define IO_PER  1  // Peripheral function
     80          #define IO_IN   0  // Input pin
     81          #define IO_OUT  1  // Output pin
     82          #define IO_PUD  0  // Pullup/pulldn input
     83          #define IO_TRI  1  // Tri-state input
     84          #define IO_PUP  0  // Pull-up input pin
     85          #define IO_PDN  1  // Pull-down input pin
     86          
     87          #define OCM_ADDRESS  (0xA0)
     88          #define OCM_READ     (0x01)
     89          #define OCM_WRITE    (0x00)
     90          #define SMB_ACK      (0)
     91          #define SMB_NAK      (1)
     92          #define SEND_STOP    (0)
     93          #define NOSEND_STOP  (1)
     94          #define SEND_START   (0)
     95          #define NOSEND_START (1)
     96          
     97          // device specific as to where the 17th address bit goes...
     98          
     99          // *************************   MACROS   ************************************
    100          #undef P
    101          
    102            /* I/O PORT CONFIGURATION */
    103          #define CAT1(x,y) x##y  // Concatenates 2 strings
    104          #define CAT2(x,y) CAT1(x,y)  // Forces evaluation of CAT1
    105          
    106          // OCM port I/O defintions
    107          // Builds I/O port name: PNAME(1,INP) ==> P1INP
    108          #define PNAME(y,z) CAT2(P,CAT2(y,z))
    109          // Builds I/O bit name: BNAME(1,2) ==> P1_2
    110          #define BNAME(port,pin) CAT2(CAT2(P,port),CAT2(_,pin))
    111          
    112          // OCM port I/O defintions
    113          #define OCM_SCL BNAME(OCM_CLK_PORT, OCM_CLK_PIN)
    114          #define OCM_SDA BNAME(OCM_DATA_PORT, OCM_DATA_PIN)
    115          
    116          #define IO_DIR_PORT_PIN(port, pin, dir) \
    117          {\
    118            if ( dir == IO_OUT ) \
    119              PNAME(port,DIR) |= (1<<(pin)); \
    120            else \
    121              PNAME(port,DIR) &= ~(1<<(pin)); \
    122          }
    123          
    124          #define OCM_DATA_HIGH()\
    125          { \
    126            IO_DIR_PORT_PIN(OCM_DATA_PORT, OCM_DATA_PIN, IO_IN); \
    127          }
    128          
    129          #define OCM_DATA_LOW() \
    130          { \
    131            IO_DIR_PORT_PIN(OCM_DATA_PORT, OCM_DATA_PIN, IO_OUT); \
    132            OCM_SDA = 0;\
    133          }
    134          
    135          #define IO_FUNC_PORT_PIN(port, pin, func) \
    136          { \
    137            if( port < 2 ) \
    138            { \
    139              if ( func == IO_PER ) \
    140                PNAME(port,SEL) |= (1<<(pin)); \
    141              else \
    142                PNAME(port,SEL) &= ~(1<<(pin)); \
    143            } \
    144            else \
    145            { \
    146              if ( func == IO_PER ) \
    147                P2SEL |= (1<<(pin>>1)); \
    148              else \
    149                P2SEL &= ~(1<<(pin>>1)); \
    150            } \
    151          }
    152          
    153          #define IO_IMODE_PORT_PIN(port, pin, mode) \
    154          { \
    155            if ( mode == IO_TRI ) \
    156              PNAME(port,INP) |= (1<<(pin)); \
    157            else \
    158              PNAME(port,INP) &= ~(1<<(pin)); \
    159          }
    160          
    161          #define IO_PUD_PORT(port, dir) \
    162          { \
    163            if ( dir == IO_PDN ) \
    164              P2INP |= (1<<(port+5)); \
    165            else \
    166              P2INP &= ~(1<<(port+5)); \
    167          }
    168          
    169          STATIC void   hali2cSend( uint8 *buffer, uint16 len, uint8 sendStart, uint8 sendStop );
    170          STATIC _Bool  hali2cSendByte( uint8 dByte );
    171          STATIC void   hali2cWrite( bool dBit );
    172          STATIC void   hali2cClock( bool dir );
    173          STATIC void   hali2cStart( void );
    174          STATIC void   hali2cStop( void );
    175          STATIC void   hali2cReceive( uint8 address, uint8 *buffer, uint16 len );
    176          STATIC uint8  hali2cReceiveByte( void );
    177          STATIC _Bool  hali2cRead( void );
    178          STATIC void   hali2cSendDeviceAddress(uint8 address);
    179          
    180          
    181          STATIC __near_func void   hali2cWait( uint8 );
    182          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    183          STATIC uint8 s_xmemIsInit;
   \                     s_xmemIsInit:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    184          
    185          /*********************************************************************
    186           * @fn      HalI2CInit
    187           * @brief   Initializes two-wire serial I/O bus
    188           * @param   void
    189           * @return  void
    190           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    191          void HalI2CInit( void )
   \                     HalI2CInit:
    192          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    193            if (!s_xmemIsInit)  {
   \   000004   90....       MOV     DPTR,#s_xmemIsInit
   \   000007   E0           MOVX    A,@DPTR
   \   000008   7019         JNZ     ??HalI2CInit_0
    194              s_xmemIsInit = 1;
   \   00000A   7401         MOV     A,#0x1
   \   00000C   F0           MOVX    @DPTR,A
    195          
    196          //    // Set port pins as inputs
    197              IO_DIR_PORT_PIN( OCM_CLK_PORT, OCM_CLK_PIN, IO_IN );
   \   00000D   53FEBF       ANL     0xfe,#0xbf
    198              IO_DIR_PORT_PIN( OCM_DATA_PORT, OCM_DATA_PIN, IO_IN );
   \   000010   53FE7F       ANL     0xfe,#0x7f
    199          //
    200          //    // Set for general I/O operation
    201              IO_FUNC_PORT_PIN( OCM_CLK_PORT, OCM_CLK_PIN, IO_GIO );
   \   000013   53F4BF       ANL     0xf4,#0xbf
    202              IO_FUNC_PORT_PIN( OCM_DATA_PORT, OCM_DATA_PIN, IO_GIO );
   \   000016   53F47F       ANL     0xf4,#0x7f
    203          //
    204          //    // Set I/O mode for pull-up/pull-down
    205              IO_IMODE_PORT_PIN( OCM_CLK_PORT, OCM_CLK_PIN, IO_PUD );
   \   000019   C296         CLR     0x90.6
    206              IO_IMODE_PORT_PIN( OCM_DATA_PORT, OCM_DATA_PIN, IO_PUD );
   \   00001B   C297         CLR     0x90.7
    207          //
    208          //    // Set pins to pull-up
    209              IO_PUD_PORT( OCM_CLK_PORT, IO_PUP );
   \   00001D   53F7BF       ANL     0xf7,#0xbf
    210              IO_PUD_PORT( OCM_DATA_PORT, IO_PUP );
   \   000020   53F7BF       ANL     0xf7,#0xbf
    211            }
    212          }
   \                     ??HalI2CInit_0:
   \   000023                REQUIRE ?Subroutine0
   \   000023                REQUIRE _A_P1
   \   000023                REQUIRE P1SEL
   \   000023                REQUIRE P2SEL
   \   000023                REQUIRE P2INP
   \   000023                REQUIRE P1DIR
   \   000023                ; // Fall through to label ?Subroutine0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine0:
   \   000000   D083         POP     DPH
   \   000002   D082         POP     DPL
   \   000004   02....       LJMP    ?BRET
    213          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    214          int8 HalI2CReceive(uint8 address, uint8 *buf, uint16 len)
   \                     HalI2CReceive:
    215          {
   \   000000   74F3         MOV     A,#-0xd
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 13
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
   \   000006   FE           MOV     R6,A
   \   000007   EB           MOV     A,R3
   \   000008   FF           MOV     R7,A
   \   000009   8C..         MOV     ?V0 + 0,R4
   \   00000B   8D..         MOV     ?V0 + 1,R5
    216            hali2cReceive(address, buf, len);
   \   00000D   EC           MOV     A,R4
   \   00000E   7001         JNZ     ??HalI2CReceive_0
   \   000010   ED           MOV     A,R5
   \                     ??HalI2CReceive_0:
   \   000011   6036         JZ      ??HalI2CReceive_1
   \   000013                ; Setup parameters for call to function hali2cSendDeviceAddress
   \   000013   12....       LCALL   ??hali2cSendDeviceAddress?relay
   \   000016   75..00       MOV     ?V0 + 2,#0x0
   \   000019   75..00       MOV     ?V0 + 3,#0x0
   \   00001C   800B         SJMP    ??CrossCallReturnLabel_6
   \                     ??HalI2CReceive_2:
   \   00001E                ; Setup parameters for call to function hali2cClock
   \   00001E   12....       LCALL   ?Subroutine2 & 0xFFFF
   \                     ??CrossCallReturnLabel_0:
   \   000021                ; Setup parameters for call to function hali2cWrite
   \   000021   7900         MOV     R1,#0x0
   \   000023   12....       LCALL   ??hali2cWrite?relay
   \   000026   12....       LCALL   ?Subroutine6 & 0xFFFF
   \                     ??CrossCallReturnLabel_6:
   \   000029   74FF         MOV     A,#-0x1
   \   00002B   25..         ADD     A,?V0 + 0
   \   00002D   F8           MOV     R0,A
   \   00002E   74FF         MOV     A,#-0x1
   \   000030   35..         ADDC    A,?V0 + 1
   \   000032   F9           MOV     R1,A
   \   000033   C3           CLR     C
   \   000034   E5..         MOV     A,?V0 + 2
   \   000036   98           SUBB    A,R0
   \   000037   E5..         MOV     A,?V0 + 3
   \   000039   99           SUBB    A,R1
   \   00003A   7900         MOV     R1,#0x0
   \   00003C   40E0         JC      ??HalI2CReceive_2
   \   00003E                ; Setup parameters for call to function hali2cClock
   \   00003E   12....       LCALL   ?Subroutine2 & 0xFFFF
   \                     ??CrossCallReturnLabel_1:
   \   000041                ; Setup parameters for call to function hali2cWrite
   \   000041   7901         MOV     R1,#0x1
   \   000043   12....       LCALL   ??hali2cWrite?relay
   \   000046                ; Setup parameters for call to function hali2cStop
   \   000046   12....       LCALL   ??hali2cStop?relay
    217          
    218            return 0;
   \                     ??HalI2CReceive_1:
   \   000049   7900         MOV     R1,#0x0
   \   00004B   7F05         MOV     R7,#0x5
   \   00004D   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   000050                REQUIRE P1DIR
    219          }
    220          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    221          int8 HalI2CSend(uint8 address, uint8 *buf, uint16 len)
   \                     HalI2CSend:
    222          {
   \   000000   74F2         MOV     A,#-0xe
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 0
   \   000005   8A..         MOV     ?V0 + 0,R2
   \   000007   8B..         MOV     ?V0 + 1,R3
   \   000009   EC           MOV     A,R4
   \   00000A   FE           MOV     R6,A
   \   00000B   ED           MOV     A,R5
   \   00000C   FF           MOV     R7,A
    223            // begin the write sequence with the address byte
    224            hali2cSendDeviceAddress(address);
   \   00000D                ; Setup parameters for call to function hali2cSendDeviceAddress
   \   00000D   12....       LCALL   ??hali2cSendDeviceAddress?relay
    225            hali2cSend(buf, len, NOSEND_START, SEND_STOP);
   \   000010   75..03       MOV     ?V0 + 5,#0x3
   \   000013   EE           MOV     A,R6
   \   000014   7001         JNZ     ??HalI2CSend_0
   \   000016   EF           MOV     A,R7
   \                     ??HalI2CSend_0:
   \   000017   602E         JZ      ??HalI2CSend_1
   \   000019   75..00       MOV     ?V0 + 2,#0x0
   \   00001C   75..00       MOV     ?V0 + 3,#0x0
   \                     ??HalI2CSend_2:
   \   00001F                ; Setup parameters for call to function hali2cSendByte
   \   00001F   E5..         MOV     A,?V0 + 0
   \   000021   25..         ADD     A,?V0 + 2
   \   000023   F582         MOV     DPL,A
   \   000025   E5..         MOV     A,?V0 + 1
   \   000027   35..         ADDC    A,?V0 + 3
   \   000029   F583         MOV     DPH,A
   \   00002B   E0           MOVX    A,@DPTR
   \   00002C   F9           MOV     R1,A
   \   00002D   12....       LCALL   ??hali2cSendByte?relay
   \   000030   4006         JC      ??HalI2CSend_3
   \   000032   15..         DEC     ?V0 + 5
   \   000034   E5..         MOV     A,?V0 + 5
   \   000036   70E7         JNZ     ??HalI2CSend_2
   \                     ??HalI2CSend_3:
   \   000038   12....       LCALL   ?Subroutine6 & 0xFFFF
   \                     ??CrossCallReturnLabel_7:
   \   00003B   C3           CLR     C
   \   00003C   E5..         MOV     A,?V0 + 2
   \   00003E   9E           SUBB    A,R6
   \   00003F   E5..         MOV     A,?V0 + 3
   \   000041   9F           SUBB    A,R7
   \   000042   40DB         JC      ??HalI2CSend_2
   \   000044                ; Setup parameters for call to function hali2cStop
   \   000044   12....       LCALL   ??hali2cStop?relay
    226          
    227            return 0;
   \                     ??HalI2CSend_1:
   \   000047   7900         MOV     R1,#0x0
   \   000049   7F06         MOV     R7,#0x6
   \   00004B   02....       LJMP    ?BANKED_LEAVE_XDATA
    228          }
    229          /*********************************************************************
    230           * @fn      hali2cSend
    231           * @brief   Sends buffer contents to SM-Bus device
    232           * @param   buffer - ptr to buffered data to send
    233           * @param   len - number of bytes in buffer
    234           * @param   sendStart - whether or not to send start condition.
    235           * @param   sendStop - whether or not to send stop condition.
    236           * @return  void
    237           */
    238          STATIC void hali2cSend( uint8 *buffer, uint16 len, uint8 sendStart, uint8 sendStop )
    239          {
    240            uint16 i;
    241            uint8 retry = HAL_I2C_RETRY_CNT;
    242          
    243            if (!len)  {
    244              return;
    245            }
    246          
    247            if (sendStart == SEND_START)  {
    248              hali2cStart();
    249            }
    250          
    251            for ( i = 0; i < len; i++ )
    252            {
    253              do {
    254                if ( hali2cSendByte( buffer[i] ) )  // takes care of ack polling
    255                {
    256                  break;
    257                }
    258              } while ( --retry );
    259            }
    260          
    261            if (sendStop == SEND_STOP) {
    262              hali2cStop();
    263            }
    264          }
    265          
    266          /*********************************************************************
    267           * @fn      hali2cSendByte
    268           * @brief   Serialize and send one byte to SM-Bus device
    269           * @param   dByte - data byte to send
    270           * @return  ACK status - 0=none, 1=received
    271           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    272          STATIC _Bool hali2cSendByte( uint8 dByte )
   \                     hali2cSendByte:
    273          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV     A,R1
   \   000006   FF           MOV     R7,A
    274            uint8 i;
    275          
    276            for ( i = 0; i < 8; i++ )
   \   000007   7E08         MOV     R6,#0x8
    277            {
    278              // Send the MSB
    279              hali2cWrite( dByte & 0x80 );
   \                     ??hali2cSendByte_0:
   \   000009                ; Setup parameters for call to function hali2cWrite
   \   000009   7480         MOV     A,#-0x80
   \   00000B   5F           ANL     A,R7
   \   00000C   F9           MOV     R1,A
   \   00000D   12....       LCALL   ??hali2cWrite?relay
    280              // Next bit into MSB
    281              dByte <<= 1;
   \   000010   EF           MOV     A,R7
   \   000011   C3           CLR     C
   \   000012   33           RLC     A
   \   000013   FF           MOV     R7,A
    282            }
   \   000014   1E           DEC     R6
   \   000015   EE           MOV     A,R6
   \   000016   70F1         JNZ     ??hali2cSendByte_0
    283            // need clock low so if the SDA transitions on the next statement the
    284            // slave doesn't stop. Also give opportunity for slave to set SDA
    285            hali2cClock( 0 );
   \   000018                ; Setup parameters for call to function hali2cClock
   \   000018   12....       LCALL   ?Subroutine3 & 0xFFFF
    286            OCM_DATA_HIGH(); // set to input to receive ack...
    287            hali2cClock( 1 );
    288            hali2cWait(1);
    289          
    290            return ( !OCM_SDA );  // Return ACK status
   \                     ??CrossCallReturnLabel_2:
   \   00001B   A297         MOV     C,0x90.7
   \   00001D   B3           CPL     C
   \   00001E   80..         SJMP    ?Subroutine1
   \   000020                REQUIRE _A_P1
   \   000020                REQUIRE P1DIR
    291          }

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine1:
   \   000000   7F01         MOV     R7,#0x1
   \   000002   02....       LJMP    ?BANKED_LEAVE_XDATA

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine3:
   \   000000   7900         MOV     R1,#0x0
   \   000002   12....       LCALL   ?Subroutine8 & 0xFFFF
   \                     ??CrossCallReturnLabel_8:
   \   000005   12....       LCALL   ?Subroutine7 & 0xFFFF
   \                     ??CrossCallReturnLabel_14:
   \   000008   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine8:
   \   000000   12....       LCALL   ??hali2cClock?relay
   \   000003   53FE7F       ANL     0xfe,#0x7f
   \   000006                ; Setup parameters for call to function hali2cClock
   \   000006                ; Setup parameters for call to function hali2cClock
   \   000006                ; Setup parameters for call to function hali2cWait
   \   000006   7901         MOV     R1,#0x1
   \   000008   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine7:
   \   000000   12....       LCALL   ??hali2cClock?relay
   \   000003                ; Setup parameters for call to function hali2cWait
   \   000003                ; Setup parameters for call to function hali2cWait
   \   000003                ; Setup parameters for call to function hali2cWait
   \   000003                ; Setup parameters for call to function hali2cWait
   \   000003                ; Setup parameters for call to function hali2cWait
   \   000003                ; Setup parameters for call to function hali2cWait
   \   000003   7901         MOV     R1,#0x1
   \   000005   12....       LCALL   hali2cWait & 0xFFFF
   \   000008   22           RET
    292          
    293          /*********************************************************************
    294           * @fn      hali2cWrite
    295           * @brief   Send one bit to SM-Bus device
    296           * @param   dBit - data bit to clock onto SM-Bus
    297           * @return  void
    298           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    299          STATIC void hali2cWrite( bool dBit )
   \                     hali2cWrite:
    300          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV     A,R1
   \   000006   FE           MOV     R6,A
    301            hali2cClock( 0 );
   \   000007                ; Setup parameters for call to function hali2cClock
   \   000007   12....       LCALL   ?Subroutine4 & 0xFFFF
    302            hali2cWait(1);
    303            if ( dBit )
   \                     ??CrossCallReturnLabel_10:
   \   00000A   EE           MOV     A,R6
   \   00000B   6005         JZ      ??hali2cWrite_0
    304            {
    305              OCM_DATA_HIGH();
   \   00000D   53FE7F       ANL     0xfe,#0x7f
   \   000010   8005         SJMP    ??hali2cWrite_1
    306            }
    307            else
    308            {
    309              OCM_DATA_LOW();
   \                     ??hali2cWrite_0:
   \   000012   43FE80       ORL     0xfe,#0x80
   \   000015   C297         CLR     0x90.7
    310            }
    311          
    312            hali2cClock(1);    
   \                     ??hali2cWrite_1:
   \   000017                ; Setup parameters for call to function hali2cClock
   \   000017   7901         MOV     R1,#0x1
   \   000019   12....       LCALL   ??Subroutine9_0 & 0xFFFF
    313            hali2cWait(1);
    314          }
   \                     ??CrossCallReturnLabel_11:
   \   00001C   80..         SJMP    ?Subroutine1
   \   00001E                REQUIRE _A_P1
   \   00001E                REQUIRE P1DIR

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine4:
   \   000000   7900         MOV     R1,#0x0
   \   000002                REQUIRE ??Subroutine9_0
   \   000002                ; // Fall through to label ??Subroutine9_0

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ??Subroutine9_0:
   \   000000   12....       LCALL   ?Subroutine7 & 0xFFFF
   \                     ??CrossCallReturnLabel_15:
   \   000003   22           RET
    315          
    316          /*********************************************************************
    317           * @fn      hali2cClock
    318           * @brief   Clocks the SM-Bus. If a negative edge is going out, the
    319           *          I/O pin is set as an output and driven low. If a positive
    320           *          edge is going out, the pin is set as an input and the pin
    321           *          pull-up drives the line high. This way, the slave device
    322           *          can hold the node low if longer setup time is desired.
    323           * @param   dir - clock line direction
    324           * @return  void
    325           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    326          STATIC void hali2cClock( bool dir )
   \                     hali2cClock:
    327          {
   \   000000   EE           MOV     A,R6
   \   000001   C0E0         PUSH    A
   \   000003                ; Saved register size: 1
   \   000003                ; Auto size: 0
   \   000003   E9           MOV     A,R1
    328            if ( dir )
   \   000004   600E         JZ      ??hali2cClock_0
    329            {
    330              IO_DIR_PORT_PIN( OCM_CLK_PORT, OCM_CLK_PIN, IO_IN );
   \   000006   53FEBF       ANL     0xfe,#0xbf
    331              while(!OCM_SCL) /* Wait until clock is high */
   \                     ??hali2cClock_1:
   \   000009   A296         MOV     C,0x90.6
   \   00000B   400C         JC      ??hali2cClock_2
    332                  hali2cWait(1);
   \   00000D                ; Setup parameters for call to function hali2cWait
   \   00000D   7901         MOV     R1,#0x1
   \   00000F   12....       LCALL   hali2cWait & 0xFFFF
   \   000012   80F5         SJMP    ??hali2cClock_1
    333            }
    334            else
    335            {
    336              IO_DIR_PORT_PIN( OCM_CLK_PORT, OCM_CLK_PIN, IO_OUT );
   \                     ??hali2cClock_0:
   \   000014   43FE40       ORL     0xfe,#0x40
    337              OCM_SCL = 0;
   \   000017   C296         CLR     0x90.6
    338            }
    339            hali2cWait(1);
   \                     ??hali2cClock_2:
   \   000019                ; Setup parameters for call to function hali2cWait
   \   000019   7901         MOV     R1,#0x1
   \   00001B   12....       LCALL   hali2cWait & 0xFFFF
    340          }
   \   00001E   D0E0         POP     A
   \   000020   FE           MOV     R6,A
   \   000021   02....       LJMP    ?BRET
   \   000024                REQUIRE _A_P1
   \   000024                REQUIRE P1DIR
    341          
    342          /*********************************************************************
    343           * @fn      hali2cStart
    344           * @brief   Initiates SM-Bus communication. Makes sure that both the
    345           *          clock and data lines of the SM-Bus are high. Then the data
    346           *          line is set high and clock line is set low to start I/O.
    347           * @param   void
    348           * @return  void
    349           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    350          STATIC void hali2cStart( void )
   \                     hali2cStart:
    351          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
    352            uint8 retry = HAL_I2C_RETRY_CNT;
   \   000005   7E03         MOV     R6,#0x3
    353          
    354            // set SCL to input but with pull-up. if slave is pulling down it will stay down.
    355            hali2cClock(1);
   \   000007                ; Setup parameters for call to function hali2cClock
   \   000007   7901         MOV     R1,#0x1
   \   000009   12....       LCALL   ??hali2cClock?relay
    356          
    357            do {
    358              // wait for slave to release clock line...
    359              if (OCM_SCL)  // wait until the line is high...
   \                     ??hali2cStart_0:
   \   00000C   A296         MOV     C,0x90.6
   \   00000E   4009         JC      ??hali2cStart_1
    360              {
    361                break;
    362              }
    363              hali2cWait(1);
   \   000010                ; Setup parameters for call to function hali2cWait
   \   000010   7901         MOV     R1,#0x1
   \   000012   12....       LCALL   hali2cWait & 0xFFFF
    364            } while ( --retry );
   \   000015   1E           DEC     R6
   \   000016   EE           MOV     A,R6
   \   000017   70F3         JNZ     ??hali2cStart_0
    365          
    366            // SCL low to set SDA high so the transition will be correct.
    367            hali2cClock(0);
   \                     ??hali2cStart_1:
   \   000019                ; Setup parameters for call to function hali2cClock
   \   000019   12....       LCALL   ?Subroutine3 & 0xFFFF
    368            OCM_DATA_HIGH();  // SDA high
    369            hali2cClock(1);      // set up for transition
    370            hali2cWait(1);
    371            OCM_DATA_LOW();   // start
   \                     ??CrossCallReturnLabel_3:
   \   00001C   12....       LCALL   ?Subroutine5 & 0xFFFF
    372          
    373            hali2cWait(1);
    374            hali2cClock( 0 );
   \                     ??CrossCallReturnLabel_4:
   \   00001F                ; Setup parameters for call to function hali2cClock
   \   00001F   7900         MOV     R1,#0x0
   \   000021   12....       LCALL   ??hali2cClock?relay
    375          }
   \   000024                REQUIRE ?Subroutine1
   \   000024                REQUIRE _A_P1
   \   000024                REQUIRE P1DIR
   \   000024                ; // Fall through to label ?Subroutine1

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine5:
   \   000000   43FE80       ORL     0xfe,#0x80
   \   000003   C297         CLR     0x90.7
   \   000005                ; Setup parameters for call to function hali2cWait
   \   000005                ; Setup parameters for call to function hali2cWait
   \   000005   7901         MOV     R1,#0x1
   \   000007   12....       LCALL   hali2cWait & 0xFFFF
   \   00000A   22           RET
    376          
    377          /*********************************************************************
    378           * @fn      hali2cStop
    379           * @brief   Terminates SM-Bus communication. Waits unitl the data line
    380           *          is low and the clock line is high. Then sets the data line
    381           *          high, keeping the clock line high to stop I/O.
    382           * @param   void
    383           * @return  void
    384           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    385          STATIC void hali2cStop( void )
   \                     hali2cStop:
    386          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    387            // Wait for clock high and data low
    388            hali2cClock(0);
   \   000004                ; Setup parameters for call to function hali2cClock
   \   000004   7900         MOV     R1,#0x0
   \   000006   12....       LCALL   ??hali2cClock?relay
    389            OCM_DATA_LOW();  // force low with SCL low
   \   000009   12....       LCALL   ?Subroutine5 & 0xFFFF
    390            hali2cWait(1);
    391          
    392            hali2cClock( 1 );
   \                     ??CrossCallReturnLabel_5:
   \   00000C                ; Setup parameters for call to function hali2cClock
   \   00000C   7901         MOV     R1,#0x1
   \   00000E   12....       LCALL   ?Subroutine8 & 0xFFFF
    393            OCM_DATA_HIGH(); // stop condition
    394            hali2cWait(1);
   \                     ??CrossCallReturnLabel_9:
   \   000011   12....       LCALL   hali2cWait & 0xFFFF
    395          
    396          }
   \   000014   02....       LJMP    ?Subroutine0 & 0xFFFF
   \   000017                REQUIRE _A_P1
   \   000017                REQUIRE P1DIR
    397          
    398          /*********************************************************************
    399           * @fn      hali2cWait
    400           * @brief   Wastes a an amount of time.
    401           * @param   count: down count in busy-wait
    402           * @return  void
    403           */

   \                                 In  segment NEAR_CODE, align 1, keep-with-next
    404          STATIC __near_func void hali2cWait( uint8 count )
   \                     hali2cWait:
    405          {
   \   000000                ; Saved register size: 0
   \   000000                ; Auto size: 0
    406            while ( count-- );
   \                     ??hali2cWait_0:
   \   000000   E9           MOV     A,R1
   \   000001   19           DEC     R1
   \   000002   70FC         JNZ     ??hali2cWait_0
    407          }
   \   000004   22           RET
    408          
    409          /*********************************************************************
    410           * @fn      hali2cReceiveByte
    411           * @brief   Read the 8 data bits.
    412           * @param   void
    413           * @return  character read
    414           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    415          STATIC uint8 hali2cReceiveByte()
   \                     hali2cReceiveByte:
    416          {
   \   000000   74F4         MOV     A,#-0xc
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 12
   \   000005                ; Auto size: 0
    417            int8 i, rval = 0;
   \   000005   75..00       MOV     ?V0 + 0,#0x0
    418          
    419            for (i=7; i>=0; --i)  {
   \   000008   7E07         MOV     R6,#0x7
    420              if (hali2cRead())  {
   \                     ??hali2cReceiveByte_0:
   \   00000A                ; Setup parameters for call to function hali2cClock
   \   00000A   12....       LCALL   ?Subroutine4 & 0xFFFF
   \                     ??CrossCallReturnLabel_13:
   \   00000D                ; Setup parameters for call to function hali2cClock
   \   00000D   7901         MOV     R1,#0x1
   \   00000F   12....       LCALL   ??Subroutine9_0 & 0xFFFF
   \                     ??CrossCallReturnLabel_12:
   \   000012   A297         MOV     C,0x90.7
   \   000014   5010         JNC     ??hali2cReceiveByte_1
    421                rval |= 1<<i;
   \   000016   75..01       MOV     ?V0 + 2,#0x1
   \   000019   75..00       MOV     ?V0 + 3,#0x0
   \   00001C   EE           MOV     A,R6
   \   00001D   78..         MOV     R0,#?V0 + 2
   \   00001F   12....       LCALL   ?S_SHL
   \   000022   E5..         MOV     A,?V0 + 2
   \   000024   42..         ORL     ?V0 + 0,A
    422              }
    423            }
   \                     ??hali2cReceiveByte_1:
   \   000026   74FF         MOV     A,#-0x1
   \   000028   2E           ADD     A,R6
   \   000029   1E           DEC     R6
   \   00002A   C3           CLR     C
   \   00002B   9400         SUBB    A,#0x0
   \   00002D   A2D2         MOV     C,0xD0 /* PSW */.2
   \   00002F   65D0         XRL     A,PSW
   \   000031   33           RLC     A
   \   000032   50D6         JNC     ??hali2cReceiveByte_0
    424          
    425            return rval;
   \   000034   A9..         MOV     R1,?V0 + 0
   \   000036   7F04         MOV     R7,#0x4
   \   000038   02....       LJMP    ?BANKED_LEAVE_XDATA
   \   00003B                REQUIRE _A_P1
    426          }
    427          /**************************************************************************************************
    428          **************************************************************************************************/
    429          /*********************************************************************
    430           * @fn      hali2cReceive
    431           * @brief   reads data into a buffer
    432           * @param   address: linear address on part from which to read
    433           * @param   buffer: target array for read characters
    434           * @param   len: max number of characters to read
    435           * @return  void
    436           */
    437          STATIC void hali2cReceive( uint8 address, uint8 *buffer, uint16 len )
    438          {
    439            //uint8  ch;
    440            uint16 i;
    441          
    442            if (!len)  {
    443              return;
    444            }
    445          
    446            hali2cSendDeviceAddress(address);
    447          
    448            //ch = OCM_ADDRESS_BYTE(0, OCM_READ);
    449            //hali2cSend(&ch, 1, SEND_START, NOSEND_STOP);
    450          
    451            for ( i = 0; i < len-1; i++ )
    452            {
    453              // SCL may be high. set SCL low. If SDA goes high when input
    454              // mode is set the slave won't see a STOP
    455              hali2cClock(0);
    456              OCM_DATA_HIGH();
    457          
    458              buffer[i] = hali2cReceiveByte();
    459              hali2cWrite(SMB_ACK);           // write leaves SCL high
    460            }
    461          
    462            // condition SDA one more time...
    463            hali2cClock(0);
    464            OCM_DATA_HIGH();
    465            buffer[i] = hali2cReceiveByte();
    466            hali2cWrite(SMB_NAK);
    467          
    468            hali2cStop();
    469          }
    470          
    471          /*********************************************************************
    472           * @fn      hali2cRead
    473           * @brief   Toggle the clock line to let the slave set the data line.
    474           *          Then read the data line.
    475           * @param   void
    476           * @return  TRUE if bit read is 1 else FALSE
    477           */
    478          STATIC _Bool hali2cRead( void )
    479          {
    480            // SCL low to let slave set SDA. SCL high for SDA
    481            // valid and then get bit
    482            hali2cClock( 0 );
    483            hali2cWait(1);
    484            hali2cClock( 1 );
    485            hali2cWait(1);
    486          
    487            return OCM_SDA;
    488          }
    489          
    490          /*********************************************************************
    491           * @fn      hali2cSendDeviceAddress
    492           * @brief   Send onlythe device address. Do ack polling
    493           *
    494           * @param   void
    495           * @return  none
    496           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    497          STATIC void hali2cSendDeviceAddress(uint8 address)
   \                     hali2cSendDeviceAddress:
    498          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   E9           MOV     A,R1
   \   000006   FE           MOV     R6,A
    499            uint8 retry = HAL_I2C_RETRY_CNT;
   \   000007   7F03         MOV     R7,#0x3
    500          
    501            do {
    502              hali2cStart();
   \                     ??hali2cSendDeviceAddress_0:
   \   000009                ; Setup parameters for call to function hali2cStart
   \   000009   12....       LCALL   ??hali2cStart?relay
    503              if (hali2cSendByte(address))  // do ack polling...
   \   00000C                ; Setup parameters for call to function hali2cSendByte
   \   00000C   EE           MOV     A,R6
   \   00000D   F9           MOV     R1,A
   \   00000E   12....       LCALL   ??hali2cSendByte?relay
   \   000011   4004         JC      ??hali2cSendDeviceAddress_1
    504              {
    505                break;
    506              }
    507            } while ( --retry );
   \   000013   1F           DEC     R7
   \   000014   EF           MOV     A,R7
   \   000015   70F2         JNZ     ??hali2cSendDeviceAddress_0
    508          }
   \                     ??hali2cSendDeviceAddress_1:
   \   000017   02....       LJMP    ?Subroutine1 & 0xFFFF

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine2:
   \   000000   12....       LCALL   ??hali2cClock?relay
   \   000003   53FE7F       ANL     0xfe,#0x7f
   \   000006                ; Setup parameters for call to function hali2cReceiveByte
   \   000006                ; Setup parameters for call to function hali2cReceiveByte
   \   000006   12....       LCALL   ??hali2cReceiveByte?relay
   \   000009   EE           MOV     A,R6
   \   00000A   25..         ADD     A,?V0 + 2
   \   00000C   F582         MOV     DPL,A
   \   00000E   EF           MOV     A,R7
   \   00000F   35..         ADDC    A,?V0 + 3
   \   000011   F583         MOV     DPH,A
   \   000013   E9           MOV     A,R1
   \   000014   F0           MOVX    @DPTR,A
   \   000015   22           RET

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   \                     ?Subroutine6:
   \   000000   E5..         MOV     A,?V0 + 2
   \   000002   2401         ADD     A,#0x1
   \   000004   F5..         MOV     ?V0 + 2,A
   \   000006   E5..         MOV     A,?V0 + 3
   \   000008   3400         ADDC    A,#0x0
   \   00000A   F5..         MOV     ?V0 + 3,A
   \   00000C   22           RET

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??HalI2CInit?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    HalI2CInit

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??HalI2CReceive?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    HalI2CReceive

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??HalI2CSend?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    HalI2CSend

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??hali2cSendByte?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    hali2cSendByte

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??hali2cWrite?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    hali2cWrite

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??hali2cClock?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    hali2cClock

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??hali2cStart?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    hali2cStart

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??hali2cStop?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    hali2cStop

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??hali2cReceiveByte?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    hali2cReceiveByte

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??hali2cSendDeviceAddress?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    hali2cSendDeviceAddress

   Maximum stack usage in bytes:

     Function                     ISTACK PSTACK XSTACK
     --------                     ------ ------ ------
     HalI2CInit                       2      0      0
     HalI2CReceive                    1      0     13
       -> hali2cSendDeviceAddress     0      0     26
       -> hali2cClock                 0      0     26
       -> hali2cReceiveByte           0      0     26
       -> hali2cWrite                 0      0     26
       -> hali2cClock                 0      0     26
       -> hali2cReceiveByte           0      0     26
       -> hali2cWrite                 0      0     26
       -> hali2cStop                  0      0     26
     HalI2CSend                       0      0     14
       -> hali2cSendDeviceAddress     0      0     28
       -> hali2cSendByte              0      0     28
       -> hali2cStop                  0      0     28
     hali2cClock                      1      0     13
       -> hali2cWait                  2      0      0
       -> hali2cWait                  2      0      0
     hali2cReceiveByte                0      0     25
       -> hali2cClock                 0      0     24
       -> hali2cWait                  0      0     24
       -> hali2cClock                 0      0     24
       -> hali2cWait                  0      0     24
     hali2cSendByte                   0      0     23
       -> hali2cWrite                 0      0     18
       -> hali2cClock                 0      0     18
       -> hali2cClock                 0      0     18
       -> hali2cWait                  0      0     18
     hali2cSendDeviceAddress          0      0     23
       -> hali2cStart                 0      0     18
       -> hali2cSendByte              0      0     18
     hali2cStart                      0      0     18
       -> hali2cClock                 0      0     18
       -> hali2cWait                  0      0     18
       -> hali2cClock                 0      0     18
       -> hali2cClock                 0      0     18
       -> hali2cWait                  0      0     18
       -> hali2cWait                  0      0     18
       -> hali2cClock                 0      0     18
     hali2cStop                       2      0     14
       -> hali2cClock                 4      0      0
       -> hali2cWait                  4      0      0
       -> hali2cClock                 4      0      0
       -> hali2cWait                  4      0      0
     hali2cWait                       0      0     12
     hali2cWrite                      0      0     22
       -> hali2cClock                 0      0     18
       -> hali2cWait                  0      0     18
       -> hali2cClock                 0      0     18
       -> hali2cWait                  0      0     18


   Segment part sizes:

     Function/Label                  Bytes
     --------------                  -----
     _A_P1                              1
     P1SEL                              1
     P2SEL                              1
     P2INP                              1
     P1DIR                              1
     s_xmemIsInit                       1
     HalI2CInit                        35
     ?Subroutine0                       7
     HalI2CReceive                     80
     HalI2CSend                        78
     hali2cSendByte                    32
     ?Subroutine1                       5
     ?Subroutine3                       9
     ?Subroutine8                       9
     ?Subroutine7                       9
     hali2cWrite                       30
     ?Subroutine4                       2
     ??Subroutine9_0                    4
     hali2cClock                       36
     hali2cStart                       36
     ?Subroutine5                      11
     hali2cStop                        23
     hali2cWait                         5
     hali2cReceiveByte                 59
     hali2cSendDeviceAddress           26
     ?Subroutine2                      22
     ?Subroutine6                      13
     ??HalI2CInit?relay                 6
     ??HalI2CReceive?relay              6
     ??HalI2CSend?relay                 6
     ??hali2cSendByte?relay             6
     ??hali2cWrite?relay                6
     ??hali2cClock?relay                6
     ??hali2cStart?relay                6
     ??hali2cStop?relay                 6
     ??hali2cReceiveByte?relay          6
     ??hali2cSendDeviceAddress?relay    6

 
 526 bytes in segment BANKED_CODE
  60 bytes in segment BANK_RELAYS
   5 bytes in segment NEAR_CODE
   5 bytes in segment SFR_AN
   1 byte  in segment XDATA_Z
 
 591 bytes of CODE  memory
   0 bytes of DATA  memory (+ 5 bytes shared)
   1 byte  of XDATA memory

Errors: none
Warnings: none
